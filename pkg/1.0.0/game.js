var Shell={boundingBox:function(x1,y1,w1,h1,x2,y2,w2,h2){if((x1>x2+w2)||(x1+w1<x2)||(y1+h1<y2)||(y1>y2+h2)){return false}return true}};var Fix=function(fixTime){this.startTime=new Date();this.progress=0;this.fixTime=fixTime},proto=Fix.prototype;proto.update=function(){var now=new Date(),time=now-this.startTime;this.progress=time/this.fixTime;if(this.progress>=1){this.progress=1}};var Worker=function(){this.fixTime=Math.floor(5000*Math.random())+5000;this.maxFix=1;this.fixArray=[]};proto=Worker.prototype;proto.update=function(){var i,fix;if(this.fixArray.length<this.maxFix){this.fixArray.push(new Fix(this.fixTime))}};var game=(function(){var pubState={wave:1,level:1,glitch:0,exp:0,maxExp:Math.pow(10,9),selfFix:{maxTime:10000,maxCount:1,last:new Date(0),multi:false,delay:300,fixArray:[]},workers:{max:0,current:[]}},setByExp=function(){var logPro=Math.log(this.exp)/Math.log(this.maxExp);logPro=logPro<0?0:logPro;this.level=Math.floor(299*Math.pow(logPro,2))+1;this.selfFix.maxCount=Math.floor(9*logPro)+1;this.workers.max=Math.floor(this.level/3);},setWave=function(wave){this.wave=wave;this.glitch=5*wave+Math.pow(2,wave-1)},onWin=function(){this.wave+=1;this.selfFix.inProgress=[];setWave.call(this,this.wave)},pubAPI={pubState:pubState,deglitch:function(count){if(typeof count==='number'&&count>0){if(pubState.glitch>=count){pubState.glitch-=count;pubState.exp+=count}else{pubState.exp+=pubState.glitch;pubState.glitch=0}if(pubState.exp>pubState.maxExp){pubState.exp=pubState.maxExp}}},fix:(function(){var pub=function(){var fixTime=pubState.selfFix.maxTime,fixPer;if(new Date()-pubState.selfFix.last>=pubState.selfFix.delay){if(pubState.selfFix.fixArray.length<pubState.selfFix.maxCount){if(pubState.selfFix.multiBonus){fixPer=pubState.selfFix.fixArray.length/pubState.selfFix.maxCount;fixTime=pubState.selfFix.maxTime-pubState.selfFix.maxTime*.90*fixPer}pubState.selfFix.fixArray.push(new Fix(fixTime))}pubState.selfFix.last=new Date()}};pub.tick=function(){var i=pubState.selfFix.fixArray.length,selfFix;while(i--){selfFix=pubState.selfFix.fixArray[i];selfFix.update();if(selfFix.progress===1){pubAPI.deglitch(1);pubState.selfFix.fixArray.splice(i,1)}}};return pub}()),update:function(){this.fix.tick();setByExp.call(pubState);if(pubState.workers.current.length<pubState.workers.max){pubState.workers.current.push(new Worker())}pubState.workers.current.forEach(function(worker){var i,fix;worker.update();i=worker.fixArray.length;while(i--){fix=worker.fixArray[i];fix.update();if(fix.progress===1){pubAPI.deglitch(1);worker.fixArray.splice(i,1)}}});if(pubState.glitch===0){onWin.call(pubState)}}};setWave.call(pubState,1);return pubAPI}());var render=(function(){var canvas,ctx,con,defaultStyle=function(){ctx.fillStyle='#000000';ctx.strokeStyle='#00ffff';ctx.font='20px courier';ctx.textBaseline='top';ctx.textAlign='center'},cls=function(){defaultStyle();ctx.fillRect(0,0,canvas.width,canvas.height)},states={start:function(){},title:function(){ctx.strokeText('deglitcher13k.',canvas.width/2,100);ctx.strokeText('(click screen)',canvas.width/2,200)},game:function(){var state=game.pubState;ctx.strokeRect(10,400,64,64);ctx.strokeText('fix',42,420);ctx.fillStyle='rgba(0,255,255,.2)';state.selfFix.fixArray.forEach(function(fix){ctx.fillRect(0,470,640*fix.progress,10)});ctx.fillStyle='rgba(255,255,255,.2)';state.workers.current.forEach(function(worker){worker.fixArray.forEach(function(fix){ctx.fillRect(0,470,640*fix.progress,10)})});ctx.textAlign='left';ctx.strokeText('wave:'+state.wave+';',10,20);ctx.strokeText('level : '+state.level+', exp: '+state.exp+';',10,40);ctx.strokeText('glitches: '+state.glitch+';',10,60)}},pubAPI={draw:function(){cls();states[main.getState()]()},setup:function(id,w,h){con=document.getElementById(id),canvas=document.createElement('canvas'),ctx=canvas.getContext('2d');canvas.width=w;canvas.height=h;con.appendChild(canvas);cls();control.attachEvents(canvas)}};return pubAPI}());var control=(function(){var fixPos=function(e){var box=e.target.getBoundingClientRect(),x,y;if(e.touches){return{x:e.touches[0].clientX-box.left,y:e.touches[0].clientY-bot.top}}return{x:e.clientX-box.left,y:e.clientY-box.top}},states={start:function(pos,e){},title:function(pos,e){main.stateChange('game')},game:function(pos,e){if(Shell.boundingBox(pos.x,pos.y,1,1,10,400,64,64)){game.fix()}}},pubAPI={attachEvents:function(canvas){canvas.addEventListener('mousedown',function(e){var pos=fixPos(e);states[main.getState()](pos,e)})}};return pubAPI}());var main=(function(){var current='start',firstRun=true,lastTick=new Date(0),tickRate=40,stateChange=function(state){current=state;firstRun=true},state={start:{firstRun:function(){render.setup('gamearea',640,480)},tick:function(){stateChange('game')}},title:{firstRun:function(){},tick:function(){}},game:{firstRun:function(){},tick:function(){game.update()}}},loop=function(){var now=new Date();requestAnimationFrame(loop);if(firstRun){state[current].firstRun();firstRun=false}if(now-lastTick>tickRate){state[current].tick();render.draw();lastTick=now}};return{stateChange:function(state){stateChange(state)},getState:function(){return current},start:function(){loop()}}}());main.start();